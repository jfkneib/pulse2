#!/usr/bin/python
# -*- coding: utf-8; -*-
#
# (c) 2007-2008 Mandriva, http://www.mandriva.com/
#
# $Id$
#
# This file is part of Pulse 2, http://pulse2.mandriva.org
#
# Pulse 2 is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# Pulse 2 is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Pulse 2; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
# MA 02110-1301, USA.

""" A simple command line wrapper
This tool expect a command line, run it, output stdout and stderr in a
demuxable-way, and give-up with the command line exit code
For exemple, "ls /mnt /nothing" whould give you:
***************************************
ls: /nothing: No such file or directory
/mnt:
nfs
***************************************
and "pulse2_output_wrapper ls /mnt /nothing" will give you:
***************************************
1199893195.42 C: ls路/mnt路/nothing
1199893195.46 E: ls: /nothing: No such file or directory
1199893195.46 E:
1199893195.46 O: /mnt:
1199893195.46 O: nfs
1199893195.46 O:
1199893195.46 X: 1
***************************************
Output lines are formatted like this:
<timestamp><space><tag><column><space><output line>
With <tag>:
  C: the command line, using '路' as separator
  S: something on stdout
  E: something on stderr
  X: the exit code

Lines are always parsed to be fully utf-8 compliant
"""
import twisted.internet.protocol
import twisted.internet.reactor
import os
import time
import sys

def format(line, tag):
    """ Format a line as expected (see upper)
    * attempt to guess encoding (currenlty try 'windows-1252', 'utf-8',
     'cp850', 'latin-1' and fallback to ascii)
    * convert to utf-8
    * format line
    """
    for codec in ['utf-8', 'cp850', 'latin-1', 'windows-1252']:
        try:
            uline = unicode(line, codec)
            break
        except UnicodeDecodeError:
            continue
    else:
        uline = unicode(line, 'ascii', 'replace')

    try:
        line = uline.encode('utf-8')
    except:
        line = uline.encode('utf-8', 'replace')

    return "%s %s: %s" % (time.time(), tag, line)

class shOutputWrapper(twisted.internet.protocol.ProcessProtocol):
    """ A twisted.internet.protocol.ProcessProtocol override to handle on-the-fly encoding transcription
    """

    def __init__(self):
        self.exitcode = 0

    def outReceived(self, data):
        """ Format stdout
        """
        for line in data.split('\n'):
            print format(line, 'O')
        return True

    def errReceived(self, data):
        """ Format stderr
        """
        for line in data.split('\n'):
            print format(line, 'E')
        return True

    def processEnded(self, reason):
        """ Fired when process has finished
        """
        print format(str(reason.value.exitCode), 'X')
        twisted.internet.reactor.stop()
        self.exitcode = reason.value.exitCode

args = os.sys.argv
# first arg is us !!!
del args[0]
print format('路'.join(args), 'C')
process = shOutputWrapper()
twisted.internet.reactor.spawnProcess(process, args[0], args)
twisted.internet.reactor.run()
sys.exit(process.exitcode)

